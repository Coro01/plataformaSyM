{% extends "control_horas/base.html" %}
{% load humanize %}

{% block title %}Asociar Productos - Gestión de Facturas{% endblock %}

{% block extra_head %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root { --burgundy: #7b2434; --burgundy-light: #fdf2f2; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .product-row { border-left: 4px solid #e2e8f0; transition: all 0.2s; }
        .product-row:hover { border-left-color: var(--burgundy); background-color: #f8fafc; }
        .error-field { border: 2px solid #ef4444 !important; }
    </style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-5xl mx-auto px-4">
        
        <div class="glass-card p-6 mb-8 border-t-4 border-t-burgundy">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Validación de Ítems</h1>
                    <p class="text-gray-500">Factura N°: <span class="font-mono font-bold text-burgundy">{{ extracted_invoice_data.numero_factura }}</span></p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold text-gray-400 uppercase">Proveedor Detectado</p>
                    <p class="font-bold text-gray-800">{{ extracted_invoice_data.Nombre_Vendedor }}</p>
                </div>
            </div>
        </div>

        <form id="invoiceForm" method="post" action="/SYM/compras/facturas/guardar/" class="space-y-6">
            {% csrf_token %}
            
            <input type="hidden" name="factura_id" value="{{ factura_id }}">

            <div class="glass-card overflow-hidden">
                <div class="bg-gray-100 px-6 py-3 border-b flex justify-between items-center">
                    <span class="text-sm font-bold text-gray-600">Productos en la Factura</span>
                    <span class="text-xs text-gray-500">{{ extracted_invoice_data.items|length }} ítems detectados</span>
                </div>

                <div class="divide-y divide-gray-100">
                    {% for item in extracted_invoice_data.items %}
                    <div class="p-6 product-row">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-center">
                            
                            <div class="md:col-span-5">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">Descripción en PDF</span>
                                <p class="text-sm font-bold text-gray-800 mb-2">{{ item.articulo }}</p>
                                <div class="flex gap-4">
                                    <div class="text-xs text-gray-500">Cant: <b class="text-gray-700">{{ item.cantidad }}</b></div>
                                    <div class="text-xs text-gray-500">Precio: <b class="text-gray-700">₲ {{ item.totalSinIVA|floatformat:0|intcomma }}</b></div>
                                </div>
                            </div>

                            <div class="md:col-span-7">
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Vincular con Producto de Inventario</label>
                                <select name="producto_id_{{ forloop.counter }}" 
                                        class="inventory-select w-full border border-gray-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-burgundy focus:outline-none"
                                        required>
                                    <option value="">-- Seleccione el producto correspondiente --</option>
                                    {% for producto in productos_disponibles %}
                                        <option value="{{ producto.CodigoProducto }}">
                                            [{{ producto.CodigoProducto }}] {{ producto.Producto }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" name="cantidad_{{ forloop.counter }}" value="{{ item.cantidad }}">
                                <p class="hidden error-msg text-[10px] text-red-500 mt-1 font-bold italic">Debe seleccionar un producto para continuar.</p>
                            </div>

                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <div class="text-left">
                    <p class="text-xs font-bold text-gray-400 uppercase leading-none">Total de la Operación</p>
                    <p class="text-3xl font-black text-green-600">₲ {{ extracted_invoice_data.Monto_Total|intcomma }}</p>
                </div>
                
                <div class="flex gap-3 w-full md:w-auto">
                    <a href="{% url 'compras:facturas' %}" class="flex-1 md:flex-none text-center px-6 py-3 rounded-lg font-bold text-gray-500 hover:bg-gray-100 transition">
                        Cancelar
                    </a>
                    <button type="submit" id="btnSubmit" class="flex-1 md:flex-none bg-burgundy text-white px-10 py-3 rounded-lg font-bold hover:opacity-90 transition shadow-lg flex items-center justify-center gap-2">
                        <i class="bi bi-cloud-check-fill"></i> Procesar Inventario
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.getElementById('invoiceForm').addEventListener('submit', function(e) {
        let hasError = false;
        const selects = document.querySelectorAll('.inventory-select');
        
        selects.forEach(select => {
            const errorMsg = select.parentElement.querySelector('.error-msg');
            if (select.value === "") {
                hasError = true;
                select.classList.add('error-field');
                errorMsg.classList.remove('hidden');
                
                // Animación de pulso para feedback visual
                select.parentElement.classList.add('animate-pulse');
                setTimeout(() => select.parentElement.classList.remove('animate-pulse'), 500);
            } else {
                select.classList.remove('error-field');
                errorMsg.classList.add('hidden');
            }
        });

        if (hasError) {
            e.preventDefault();
            alert('⚠️ Por favor, asocie todos los productos del PDF con un ítem del inventario antes de guardar.');
        } else {
            // Deshabilitar botón para evitar doble envío de inventario
            const btn = document.getElementById('btnSubmit');
            btn.innerHTML = '<i class="bi bi-hourglass-split animate-spin"></i> Guardando...';
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            // No usamos btn.disabled = true aquí inmediatamente para asegurar que el form se envíe en todos los navegadores
        }
    });

    // Limpiar estados de error en tiempo real
    document.querySelectorAll('.inventory-select').forEach(select => {
        select.addEventListener('change', function() {
            if (this.value !== "") {
                this.classList.remove('error-field');
                const errorMsg = this.parentElement.querySelector('.error-msg');
                if(errorMsg) errorMsg.classList.add('hidden');
            }
        });
    });
</script>
{% endblock %}